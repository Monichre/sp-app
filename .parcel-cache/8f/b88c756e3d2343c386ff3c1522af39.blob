var $e6cd2a7aef2a824305ae4bde00692dbe$exports = {};
$parcel$require("e6cd2a7aef2a824305ae4bde00692dbe", "@firebase/app");
$parcel$require("e6cd2a7aef2a824305ae4bde00692dbe", "@firebase/util");
$parcel$require("e6cd2a7aef2a824305ae4bde00692dbe", "idb");

/*! *****************************************************************************
Copyright (c) Microsoft Corporation. All rights reserved.
Licensed under the Apache License, Version 2.0 (the "License"); you may not use
this file except in compliance with the License. You may obtain a copy of the
License at http://www.apache.org/licenses/LICENSE-2.0

THIS CODE IS PROVIDED ON AN *AS IS* BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, EITHER EXPRESS OR IMPLIED, INCLUDING WITHOUT LIMITATION ANY IMPLIED
WARRANTIES OR CONDITIONS OF TITLE, FITNESS FOR A PARTICULAR PURPOSE,
MERCHANTABLITY OR NON-INFRINGEMENT.

See the Apache Version 2.0 License for specific language governing permissions
and limitations under the License.
***************************************************************************** */

/* global Reflect, Promise */
var $e6cd2a7aef2a824305ae4bde00692dbe$var$extendStatics = function (d, b) {
  $e6cd2a7aef2a824305ae4bde00692dbe$var$extendStatics = Object.setPrototypeOf || {
    __proto__: []
  } instanceof Array && function (d, b) {
    d.__proto__ = b;
  } || function (d, b) {
    for (var p in b) if (b.hasOwnProperty(p)) d[p] = b[p];
  };

  return $e6cd2a7aef2a824305ae4bde00692dbe$var$extendStatics(d, b);
};

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__extends(d, b) {
  $e6cd2a7aef2a824305ae4bde00692dbe$var$extendStatics(d, b);

  function __() {
    this.constructor = d;
  }

  d.prototype = b === null ? Object.create(b) : (__.prototype = b.prototype, new __());
}

var $e6cd2a7aef2a824305ae4bde00692dbe$var$__assign = function () {
  $e6cd2a7aef2a824305ae4bde00692dbe$var$__assign = Object.assign || function __assign(t) {
    for (var s, i = 1, n = arguments.length; i < n; i++) {
      s = arguments[i];

      for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p)) t[p] = s[p];
    }

    return t;
  };

  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__assign.apply(this, arguments);
};

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__rest(s, e) {
  var t = {};

  for (var p in s) if (Object.prototype.hasOwnProperty.call(s, p) && e.indexOf(p) < 0) t[p] = s[p];

  if (s != null && typeof Object.getOwnPropertySymbols === "function") for (var i = 0, p = Object.getOwnPropertySymbols(s); i < p.length; i++) if (e.indexOf(p[i]) < 0) t[p[i]] = s[p[i]];
  return t;
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__decorate(decorators, target, key, desc) {
  var c = arguments.length,
      r = c < 3 ? target : desc === null ? desc = Object.getOwnPropertyDescriptor(target, key) : desc,
      d;
  if (typeof Reflect === "object" && typeof Reflect.decorate === "function") r = Reflect.decorate(decorators, target, key, desc);else for (var i = decorators.length - 1; i >= 0; i--) if (d = decorators[i]) r = (c < 3 ? d(r) : c > 3 ? d(target, key, r) : d(target, key)) || r;
  return c > 3 && r && Object.defineProperty(target, key, r), r;
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__param(paramIndex, decorator) {
  return function (target, key) {
    decorator(target, key, paramIndex);
  };
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__metadata(metadataKey, metadataValue) {
  if (typeof Reflect === "object" && typeof Reflect.metadata === "function") return Reflect.metadata(metadataKey, metadataValue);
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(thisArg, _arguments, P, generator) {
  return new (P || (P = Promise))(function (resolve, reject) {
    function fulfilled(value) {
      try {
        step(generator.next(value));
      } catch (e) {
        reject(e);
      }
    }

    function rejected(value) {
      try {
        step(generator["throw"](value));
      } catch (e) {
        reject(e);
      }
    }

    function step(result) {
      result.done ? resolve(result.value) : new P(function (resolve) {
        resolve(result.value);
      }).then(fulfilled, rejected);
    }

    step((generator = generator.apply(thisArg, _arguments || [])).next());
  });
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(thisArg, body) {
  var _ = {
    label: 0,
    sent: function () {
      if (t[0] & 1) throw t[1];
      return t[1];
    },
    trys: [],
    ops: []
  },
      f,
      y,
      t,
      g;
  return g = {
    next: verb(0),
    "throw": verb(1),
    "return": verb(2)
  }, typeof Symbol === "function" && (g[Symbol.iterator] = function () {
    return this;
  }), g;

  function verb(n) {
    return function (v) {
      return step([n, v]);
    };
  }

  function step(op) {
    if (f) throw new TypeError("Generator is already executing.");

    while (_) try {
      if (f = 1, y && (t = op[0] & 2 ? y["return"] : op[0] ? y["throw"] || ((t = y["return"]) && t.call(y), 0) : y.next) && !(t = t.call(y, op[1])).done) return t;
      if (y = 0, t) op = [op[0] & 2, t.value];

      switch (op[0]) {
        case 0:
        case 1:
          t = op;
          break;

        case 4:
          _.label++;
          return {
            value: op[1],
            done: false
          };

        case 5:
          _.label++;
          y = op[1];
          op = [0];
          continue;

        case 7:
          op = _.ops.pop();

          _.trys.pop();

          continue;

        default:
          if (!(t = _.trys, t = t.length > 0 && t[t.length - 1]) && (op[0] === 6 || op[0] === 2)) {
            _ = 0;
            continue;
          }

          if (op[0] === 3 && (!t || op[1] > t[0] && op[1] < t[3])) {
            _.label = op[1];
            break;
          }

          if (op[0] === 6 && _.label < t[1]) {
            _.label = t[1];
            t = op;
            break;
          }

          if (t && _.label < t[2]) {
            _.label = t[2];

            _.ops.push(op);

            break;
          }

          if (t[2]) _.ops.pop();

          _.trys.pop();

          continue;
      }

      op = body.call(thisArg, _);
    } catch (e) {
      op = [6, e];
      y = 0;
    } finally {
      f = t = 0;
    }

    if (op[0] & 5) throw op[1];
    return {
      value: op[0] ? op[1] : void 0,
      done: true
    };
  }
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__exportStar(m, exports) {
  for (var p in m) if (!exports.hasOwnProperty(p)) exports[p] = m[p];
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__values(o) {
  var m = typeof Symbol === "function" && o[Symbol.iterator],
      i = 0;
  if (m) return m.call(o);
  return {
    next: function () {
      if (o && i >= o.length) o = void 0;
      return {
        value: o && o[i++],
        done: !o
      };
    }
  };
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__read(o, n) {
  var m = typeof Symbol === "function" && o[Symbol.iterator];
  if (!m) return o;
  var i = m.call(o),
      r,
      ar = [],
      e;

  try {
    while ((n === void 0 || n-- > 0) && !(r = i.next()).done) ar.push(r.value);
  } catch (error) {
    e = {
      error: error
    };
  } finally {
    try {
      if (r && !r.done && (m = i["return"])) m.call(i);
    } finally {
      if (e) throw e.error;
    }
  }

  return ar;
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__spread() {
  for (var ar = [], i = 0; i < arguments.length; i++) ar = ar.concat($e6cd2a7aef2a824305ae4bde00692dbe$var$__read(arguments[i]));

  return ar;
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__await(v) {
  return this instanceof $e6cd2a7aef2a824305ae4bde00692dbe$var$__await ? (this.v = v, this) : new $e6cd2a7aef2a824305ae4bde00692dbe$var$__await(v);
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__asyncGenerator(thisArg, _arguments, generator) {
  if (!Symbol.asyncIterator) throw new TypeError("Symbol.asyncIterator is not defined.");
  var g = generator.apply(thisArg, _arguments || []),
      i,
      q = [];
  return i = {}, verb("next"), verb("throw"), verb("return"), i[Symbol.asyncIterator] = function () {
    return this;
  }, i;

  function verb(n) {
    if (g[n]) i[n] = function (v) {
      return new Promise(function (a, b) {
        q.push([n, v, a, b]) > 1 || resume(n, v);
      });
    };
  }

  function resume(n, v) {
    try {
      step(g[n](v));
    } catch (e) {
      settle(q[0][3], e);
    }
  }

  function step(r) {
    r.value instanceof $e6cd2a7aef2a824305ae4bde00692dbe$var$__await ? Promise.resolve(r.value.v).then(fulfill, reject) : settle(q[0][2], r);
  }

  function fulfill(value) {
    resume("next", value);
  }

  function reject(value) {
    resume("throw", value);
  }

  function settle(f, v) {
    if (f(v), q.shift(), q.length) resume(q[0][0], q[0][1]);
  }
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__asyncDelegator(o) {
  var i, p;
  return i = {}, verb("next"), verb("throw", function (e) {
    throw e;
  }), verb("return"), i[Symbol.iterator] = function () {
    return this;
  }, i;

  function verb(n, f) {
    i[n] = o[n] ? function (v) {
      return (p = !p) ? {
        value: $e6cd2a7aef2a824305ae4bde00692dbe$var$__await(o[n](v)),
        done: n === "return"
      } : f ? f(v) : v;
    } : f;
  }
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__asyncValues(o) {
  if (!Symbol.asyncIterator) throw new TypeError("Symbol.asyncIterator is not defined.");
  var m = o[Symbol.asyncIterator],
      i;
  return m ? m.call(o) : (o = typeof $e6cd2a7aef2a824305ae4bde00692dbe$var$__values === "function" ? $e6cd2a7aef2a824305ae4bde00692dbe$var$__values(o) : o[Symbol.iterator](), i = {}, verb("next"), verb("throw"), verb("return"), i[Symbol.asyncIterator] = function () {
    return this;
  }, i);

  function verb(n) {
    i[n] = o[n] && function (v) {
      return new Promise(function (resolve, reject) {
        v = o[n](v), settle(resolve, reject, v.done, v.value);
      });
    };
  }

  function settle(resolve, reject, d, v) {
    Promise.resolve(v).then(function (v) {
      resolve({
        value: v,
        done: d
      });
    }, reject);
  }
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__makeTemplateObject(cooked, raw) {
  if (Object.defineProperty) {
    Object.defineProperty(cooked, "raw", {
      value: raw
    });
  } else {
    cooked.raw = raw;
  }

  return cooked;
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__importStar(mod) {
  if (mod && mod.__esModule) return mod;
  var result = {};
  if (mod != null) for (var k in mod) if (Object.hasOwnProperty.call(mod, k)) result[k] = mod[k];
  result.default = mod;
  return result;
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$__importDefault(mod) {
  return mod && mod.__esModule ? mod : {
    default: mod
  };
}

var $e6cd2a7aef2a824305ae4bde00692dbe$var$tslib_1 =
/*#__PURE__*/
Object.freeze({
  __extends: $e6cd2a7aef2a824305ae4bde00692dbe$var$__extends,

  get __assign() {
    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__assign;
  },

  __rest: $e6cd2a7aef2a824305ae4bde00692dbe$var$__rest,
  __decorate: $e6cd2a7aef2a824305ae4bde00692dbe$var$__decorate,
  __param: $e6cd2a7aef2a824305ae4bde00692dbe$var$__param,
  __metadata: $e6cd2a7aef2a824305ae4bde00692dbe$var$__metadata,
  __awaiter: $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter,
  __generator: $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator,
  __exportStar: $e6cd2a7aef2a824305ae4bde00692dbe$var$__exportStar,
  __values: $e6cd2a7aef2a824305ae4bde00692dbe$var$__values,
  __read: $e6cd2a7aef2a824305ae4bde00692dbe$var$__read,
  __spread: $e6cd2a7aef2a824305ae4bde00692dbe$var$__spread,
  __await: $e6cd2a7aef2a824305ae4bde00692dbe$var$__await,
  __asyncGenerator: $e6cd2a7aef2a824305ae4bde00692dbe$var$__asyncGenerator,
  __asyncDelegator: $e6cd2a7aef2a824305ae4bde00692dbe$var$__asyncDelegator,
  __asyncValues: $e6cd2a7aef2a824305ae4bde00692dbe$var$__asyncValues,
  __makeTemplateObject: $e6cd2a7aef2a824305ae4bde00692dbe$var$__makeTemplateObject,
  __importStar: $e6cd2a7aef2a824305ae4bde00692dbe$var$__importStar,
  __importDefault: $e6cd2a7aef2a824305ae4bde00692dbe$var$__importDefault
});
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

var $e6cd2a7aef2a824305ae4bde00692dbe$var$PENDING_TIMEOUT_MS = 10000;
var $e6cd2a7aef2a824305ae4bde00692dbe$var$PACKAGE_VERSION = 'w:0.1.0'; // Will be replaced by Rollup

var $e6cd2a7aef2a824305ae4bde00692dbe$var$INTERNAL_AUTH_VERSION = 'FIS_v2';
var $e6cd2a7aef2a824305ae4bde00692dbe$var$INSTALLATIONS_API_URL = 'https://firebaseinstallations.googleapis.com/v1';
var $e6cd2a7aef2a824305ae4bde00692dbe$var$TOKEN_EXPIRATION_BUFFER = 60 * 60 * 1000; // One hour

var $e6cd2a7aef2a824305ae4bde00692dbe$var$SERVICE = 'installations';
var $e6cd2a7aef2a824305ae4bde00692dbe$var$SERVICE_NAME = 'Installations';
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

var $e6cd2a7aef2a824305ae4bde00692dbe$var$_a;
var $e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_DESCRIPTION_MAP = ($e6cd2a7aef2a824305ae4bde00692dbe$var$_a = {}, $e6cd2a7aef2a824305ae4bde00692dbe$var$_a["missing-app-config-values"
/* MISSING_APP_CONFIG_VALUES */
] = 'Missing App configuration values.', $e6cd2a7aef2a824305ae4bde00692dbe$var$_a["create-installation-failed"
/* CREATE_INSTALLATION_FAILED */
] = 'Could not register Firebase Installation.', $e6cd2a7aef2a824305ae4bde00692dbe$var$_a["generate-token-failed"
/* GENERATE_TOKEN_FAILED */
] = 'Could not generate Auth Token.', $e6cd2a7aef2a824305ae4bde00692dbe$var$_a["not-registered"
/* NOT_REGISTERED */
] = 'Firebase Installation is not registered.', $e6cd2a7aef2a824305ae4bde00692dbe$var$_a["installation-not-found"
/* INSTALLATION_NOT_FOUND */
] = 'Firebase Installation not found.', $e6cd2a7aef2a824305ae4bde00692dbe$var$_a["request-failed"
/* REQUEST_FAILED */
] = '{$requestName} request failed with error "{$serverCode} {$serverStatus}: {$serverMessage}"', $e6cd2a7aef2a824305ae4bde00692dbe$var$_a["app-offline"
/* APP_OFFLINE */
] = 'Could not process request. Application offline.', $e6cd2a7aef2a824305ae4bde00692dbe$var$_a["delete-pending-registration"
/* DELETE_PENDING_REGISTRATION */
] = "Can't delete installation while there is a pending registration request.", $e6cd2a7aef2a824305ae4bde00692dbe$var$_a);
var $e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_FACTORY = new $e6cd2a7aef2a824305ae4bde00692dbe$import$ErrorFactory($e6cd2a7aef2a824305ae4bde00692dbe$var$SERVICE, $e6cd2a7aef2a824305ae4bde00692dbe$var$SERVICE_NAME, $e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_DESCRIPTION_MAP);
/** Returns true if error is a FirebaseError that is based on an error from the server. */

function $e6cd2a7aef2a824305ae4bde00692dbe$var$isServerError(error) {
  return error instanceof $e6cd2a7aef2a824305ae4bde00692dbe$import$FirebaseError && error.code.includes("request-failed"
  /* REQUEST_FAILED */
  );
}
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$extractAppConfig(app) {
  if (!app || !app.options) {
    throw $e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_FACTORY.create("missing-app-config-values"
    /* MISSING_APP_CONFIG_VALUES */
    );
  }

  var appName = app.name;
  var _a = app.options,
      projectId = _a.projectId,
      apiKey = _a.apiKey,
      appId = _a.appId;

  if (!appName || !projectId || !apiKey || !appId) {
    throw $e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_FACTORY.create("missing-app-config-values"
    /* MISSING_APP_CONFIG_VALUES */
    );
  }

  return {
    appName: appName,
    projectId: projectId,
    apiKey: apiKey,
    appId: appId
  };
}
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$getInstallationsEndpoint(_a) {
  var projectId = _a.projectId;
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$INSTALLATIONS_API_URL + "/projects/" + projectId + "/installations";
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$extractAuthTokenInfoFromResponse(response) {
  return {
    token: response.token,
    requestStatus: 2
    /* COMPLETED */
    ,
    expiresIn: $e6cd2a7aef2a824305ae4bde00692dbe$var$getExpiresInFromResponseExpiresIn(response.expiresIn),
    creationTime: Date.now()
  };
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$getErrorFromResponse(requestName, response) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var responseJson, errorData;
    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_a) {
      switch (_a.label) {
        case 0:
          return [4
          /*yield*/
          , response.json()];

        case 1:
          responseJson = _a.sent();
          errorData = responseJson.error;
          return [2
          /*return*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_FACTORY.create("request-failed"
          /* REQUEST_FAILED */
          , {
            requestName: requestName,
            serverCode: errorData.code,
            serverMessage: errorData.message,
            serverStatus: errorData.status
          })];
      }
    });
  });
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$getHeaders(_a) {
  var apiKey = _a.apiKey;
  return new Headers({
    'Content-Type': 'application/json',
    Accept: 'application/json',
    'x-goog-api-key': apiKey
  });
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$getHeadersWithAuth(appConfig, _a) {
  var refreshToken = _a.refreshToken;
  var headers = $e6cd2a7aef2a824305ae4bde00692dbe$var$getHeaders(appConfig);
  headers.append('Authorization', $e6cd2a7aef2a824305ae4bde00692dbe$var$getAuthorizationHeader(refreshToken));
  return headers;
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$getExpiresInFromResponseExpiresIn(responseExpiresIn) {
  // This works because the server will never respond with fractions of a second.
  return Number(responseExpiresIn.replace('s', '000'));
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$getAuthorizationHeader(refreshToken) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$INTERNAL_AUTH_VERSION + " " + refreshToken;
}
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$createInstallation(appConfig, _a) {
  var fid = _a.fid;
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var endpoint, headers, body, request, response, responseValue, registeredInstallationEntry;
    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_b) {
      switch (_b.label) {
        case 0:
          endpoint = $e6cd2a7aef2a824305ae4bde00692dbe$var$getInstallationsEndpoint(appConfig);
          headers = $e6cd2a7aef2a824305ae4bde00692dbe$var$getHeaders(appConfig);
          body = {
            fid: fid,
            authVersion: $e6cd2a7aef2a824305ae4bde00692dbe$var$INTERNAL_AUTH_VERSION,
            appId: appConfig.appId,
            sdkVersion: $e6cd2a7aef2a824305ae4bde00692dbe$var$PACKAGE_VERSION
          };
          request = {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body)
          };
          return [4
          /*yield*/
          , fetch(endpoint, request)];

        case 1:
          response = _b.sent();
          if (!response.ok) return [3
          /*break*/
          , 3];
          return [4
          /*yield*/
          , response.json()];

        case 2:
          responseValue = _b.sent();
          registeredInstallationEntry = {
            fid: fid,
            registrationStatus: 2
            /* COMPLETED */
            ,
            refreshToken: responseValue.refreshToken,
            authToken: $e6cd2a7aef2a824305ae4bde00692dbe$var$extractAuthTokenInfoFromResponse(responseValue.authToken)
          };
          return [2
          /*return*/
          , registeredInstallationEntry];

        case 3:
          throw $e6cd2a7aef2a824305ae4bde00692dbe$var$getErrorFromResponse('Create Installation', response);
      }
    });
  });
}
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/** Returns a promise that resolves after given time passes. */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$sleep(ms) {
  return new Promise(function (resolve) {
    setTimeout(resolve, ms);
  });
}
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$bufferToBase64UrlSafe(buffer) {
  var array = buffer instanceof Uint8Array ? buffer : new Uint8Array(buffer);
  var b64 = btoa(String.fromCharCode.apply(String, $e6cd2a7aef2a824305ae4bde00692dbe$var$__spread(array)));
  return b64.replace(/\+/g, '-').replace(/\//g, '_');
}
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/** Generates a new FID using random values from Web Crypto API. */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$generateFid() {
  // A valid FID has exactly 22 base64 characters, which is 132 bits, or 16.5
  // bytes. our implementation generates a 17 byte array instead.
  var fidByteArray = new Uint8Array(17);
  crypto.getRandomValues(fidByteArray); // Replace the first 4 random bits with the constant FID header of 0b0111.

  fidByteArray[0] = 112 + fidByteArray[0] % 16;
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$encode(fidByteArray);
}
/** Converts a FID Uint8Array to a base64 string representation. */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$encode(fidByteArray) {
  var b64String = $e6cd2a7aef2a824305ae4bde00692dbe$var$bufferToBase64UrlSafe(fidByteArray); // Remove the 23rd character that was added because of the extra 4 bits at the
  // end of our 17 byte array, and the '=' padding.

  return b64String.substr(0, 22);
}
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


var $e6cd2a7aef2a824305ae4bde00692dbe$var$DATABASE_NAME = 'firebase-installations-database';
var $e6cd2a7aef2a824305ae4bde00692dbe$var$DATABASE_VERSION = 1;
var $e6cd2a7aef2a824305ae4bde00692dbe$var$OBJECT_STORE_NAME = 'firebase-installations-store';
var $e6cd2a7aef2a824305ae4bde00692dbe$var$dbPromise = $e6cd2a7aef2a824305ae4bde00692dbe$import$openDb($e6cd2a7aef2a824305ae4bde00692dbe$var$DATABASE_NAME, $e6cd2a7aef2a824305ae4bde00692dbe$var$DATABASE_VERSION, function (upgradeDB) {
  // We don't use 'break' in this switch statement, the fall-through
  // behavior is what we want, because if there are multiple versions between
  // the old version and the current version, we want ALL the migrations
  // that correspond to those versions to run, not only the last one.
  switch (upgradeDB.oldVersion) {
    case 0:
      upgradeDB.createObjectStore($e6cd2a7aef2a824305ae4bde00692dbe$var$OBJECT_STORE_NAME);
  }
});
/** Assigns or overwrites the record for the given key with the given value. */

function $e6cd2a7aef2a824305ae4bde00692dbe$var$set(appConfig, value) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var key, db, tx;
    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_a) {
      switch (_a.label) {
        case 0:
          key = $e6cd2a7aef2a824305ae4bde00692dbe$var$getKey(appConfig);
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$dbPromise];

        case 1:
          db = _a.sent();
          tx = db.transaction($e6cd2a7aef2a824305ae4bde00692dbe$var$OBJECT_STORE_NAME, 'readwrite');
          tx.objectStore($e6cd2a7aef2a824305ae4bde00692dbe$var$OBJECT_STORE_NAME).put(value, key);
          return [4
          /*yield*/
          , tx.complete];

        case 2:
          _a.sent();

          return [2
          /*return*/
          , value];
      }
    });
  });
}
/** Removes record(s) from the objectStore that match the given key. */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$remove(appConfig) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var key, db, tx;
    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_a) {
      switch (_a.label) {
        case 0:
          key = $e6cd2a7aef2a824305ae4bde00692dbe$var$getKey(appConfig);
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$dbPromise];

        case 1:
          db = _a.sent();
          tx = db.transaction($e6cd2a7aef2a824305ae4bde00692dbe$var$OBJECT_STORE_NAME, 'readwrite');
          tx.objectStore($e6cd2a7aef2a824305ae4bde00692dbe$var$OBJECT_STORE_NAME).delete(key);
          return [2
          /*return*/
          , tx.complete];
      }
    });
  });
}
/**
 * Atomically updates a record with the result of updateFn, which gets
 * called with the current value. If newValue is undefined, the record is
 * deleted instead.
 * @return Updated value
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$update(appConfig, updateFn) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var key, db, tx, store, oldValue, newValue;
    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_a) {
      switch (_a.label) {
        case 0:
          key = $e6cd2a7aef2a824305ae4bde00692dbe$var$getKey(appConfig);
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$dbPromise];

        case 1:
          db = _a.sent();
          tx = db.transaction($e6cd2a7aef2a824305ae4bde00692dbe$var$OBJECT_STORE_NAME, 'readwrite');
          store = tx.objectStore($e6cd2a7aef2a824305ae4bde00692dbe$var$OBJECT_STORE_NAME);
          return [4
          /*yield*/
          , store.get(key)];

        case 2:
          oldValue = _a.sent();
          newValue = updateFn(oldValue);

          if (newValue === oldValue) {
            return [2
            /*return*/
            , newValue];
          }

          if (newValue === undefined) {
            store.delete(key);
          } else {
            store.put(newValue, key);
          }

          return [4
          /*yield*/
          , tx.complete];

        case 3:
          _a.sent();

          return [2
          /*return*/
          , newValue];
      }
    });
  });
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$getKey(appConfig) {
  return appConfig.appName + "!" + appConfig.appId;
}
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/**
 * Updates and returns the InstallationEntry from the database.
 * Also triggers a registration request if it is necessary and possible.
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$getInstallationEntry(appConfig) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var registrationPromise, _a;

    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_b) {
      switch (_b.label) {
        case 0:
          _a = {};
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$update(appConfig, function (oldEntry) {
            var installationEntry = $e6cd2a7aef2a824305ae4bde00692dbe$var$updateOrCreateFid(oldEntry);
            var entryWithPromise = $e6cd2a7aef2a824305ae4bde00692dbe$var$triggerRegistrationIfNecessary(appConfig, installationEntry);
            registrationPromise = entryWithPromise.registrationPromise;
            return entryWithPromise.installationEntry;
          })];

        case 1:
          return [2
          /*return*/
          , (_a.installationEntry = _b.sent(), _a.registrationPromise = registrationPromise, _a)];
      }
    });
  });
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$updateOrCreateFid(oldEntry) {
  var entry = oldEntry || {
    fid: $e6cd2a7aef2a824305ae4bde00692dbe$var$generateFid(),
    registrationStatus: 0
    /* NOT_STARTED */

  };

  if ($e6cd2a7aef2a824305ae4bde00692dbe$var$hasInstallationRequestTimedOut(entry)) {
    return {
      fid: entry.fid,
      registrationStatus: 0
      /* NOT_STARTED */

    };
  }

  return entry;
}
/**
 * If the Firebase Installation is not registered yet, this will trigger the registration
 * and return an InProgressInstallationEntry.
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$triggerRegistrationIfNecessary(appConfig, installationEntry) {
  if (installationEntry.registrationStatus === 0
  /* NOT_STARTED */
  ) {
      if (!navigator.onLine) {
        // Registration required but app is offline.
        var registrationPromiseWithError = Promise.reject($e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_FACTORY.create("app-offline"
        /* APP_OFFLINE */
        ));
        return {
          installationEntry: installationEntry,
          registrationPromise: registrationPromiseWithError
        };
      } // Try registering. Change status to IN_PROGRESS.


      var inProgressEntry = {
        fid: installationEntry.fid,
        registrationStatus: 1
        /* IN_PROGRESS */
        ,
        registrationTime: Date.now()
      };
      var registrationPromise = $e6cd2a7aef2a824305ae4bde00692dbe$var$registerInstallation(appConfig, inProgressEntry);
      return {
        installationEntry: inProgressEntry,
        registrationPromise: registrationPromise
      };
    } else if (installationEntry.registrationStatus === 1
  /* IN_PROGRESS */
  ) {
      return {
        installationEntry: installationEntry,
        registrationPromise: $e6cd2a7aef2a824305ae4bde00692dbe$var$waitUntilFidRegistration(appConfig)
      };
    } else {
    return {
      installationEntry: installationEntry
    };
  }
}
/** This will be executed only once for each new Firebase Installation. */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$registerInstallation(appConfig, installationEntry) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var registeredInstallationEntry, e_1;
    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_a) {
      switch (_a.label) {
        case 0:
          _a.trys.push([0, 3,, 8]);

          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$createInstallation(appConfig, installationEntry)];

        case 1:
          registeredInstallationEntry = _a.sent();
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$set(appConfig, registeredInstallationEntry)];

        case 2:
          _a.sent();

          return [3
          /*break*/
          , 8];

        case 3:
          e_1 = _a.sent();
          if (!($e6cd2a7aef2a824305ae4bde00692dbe$var$isServerError(e_1) && e_1.serverCode === 409)) return [3
          /*break*/
          , 5]; // Server returned a "FID can not be used" error.
          // Generate a new ID next time.

          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$remove(appConfig)];

        case 4:
          // Server returned a "FID can not be used" error.
          // Generate a new ID next time.
          _a.sent();

          return [3
          /*break*/
          , 7];

        case 5:
          // Registration failed. Set FID as not registered.
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$set(appConfig, {
            fid: installationEntry.fid,
            registrationStatus: 0
            /* NOT_STARTED */

          })];

        case 6:
          // Registration failed. Set FID as not registered.
          _a.sent();

          _a.label = 7;

        case 7:
          throw e_1;

        case 8:
          return [2
          /*return*/
          ];
      }
    });
  });
}
/** Call if FID registration is pending. */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$waitUntilFidRegistration(appConfig) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var entry;
    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_a) {
      switch (_a.label) {
        case 0:
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$updateInstallationRequest(appConfig)];

        case 1:
          entry = _a.sent();
          _a.label = 2;

        case 2:
          if (!(entry.registrationStatus === 1
          /* IN_PROGRESS */
          )) return [3
            /*break*/
            , 5]; // createInstallation request still in progress.

          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$sleep(100)];

        case 3:
          // createInstallation request still in progress.
          _a.sent();

          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$updateInstallationRequest(appConfig)];

        case 4:
          entry = _a.sent();
          return [3
          /*break*/
          , 2];

        case 5:
          if (entry.registrationStatus === 0
          /* NOT_STARTED */
          ) {
              throw $e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_FACTORY.create("create-installation-failed"
              /* CREATE_INSTALLATION_FAILED */
              );
            }

          return [2
          /*return*/
          ];
      }
    });
  });
}
/**
 * Called only if there is a CreateInstallation request in progress.
 *
 * Updates the InstallationEntry in the DB based on the status of the
 * CreateInstallation request.
 *
 * Returns the updated InstallationEntry.
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$updateInstallationRequest(appConfig) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$update(appConfig, function (oldEntry) {
    if (!oldEntry) {
      throw $e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_FACTORY.create("installation-not-found"
      /* INSTALLATION_NOT_FOUND */
      );
    }

    if ($e6cd2a7aef2a824305ae4bde00692dbe$var$hasInstallationRequestTimedOut(oldEntry)) {
      return {
        fid: oldEntry.fid,
        registrationStatus: 0
        /* NOT_STARTED */

      };
    }

    return oldEntry;
  });
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$hasInstallationRequestTimedOut(installationEntry) {
  return installationEntry.registrationStatus === 1
  /* IN_PROGRESS */
  && installationEntry.registrationTime + $e6cd2a7aef2a824305ae4bde00692dbe$var$PENDING_TIMEOUT_MS < Date.now();
}
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$getId(app) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var appConfig, _a, installationEntry, registrationPromise;

    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_b) {
      switch (_b.label) {
        case 0:
          appConfig = $e6cd2a7aef2a824305ae4bde00692dbe$var$extractAppConfig(app);
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$getInstallationEntry(appConfig)];

        case 1:
          _a = _b.sent(), installationEntry = _a.installationEntry, registrationPromise = _a.registrationPromise;

          if (registrationPromise) {
            // Suppress registration errors as they are not a problem for getId.
            registrationPromise.catch(function () {});
          }

          return [2
          /*return*/
          , installationEntry.fid];
      }
    });
  });
}
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$generateAuthToken(appConfig, installationEntry) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var endpoint, headers, body, request, response, responseValue, completedAuthToken;
    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_a) {
      switch (_a.label) {
        case 0:
          endpoint = $e6cd2a7aef2a824305ae4bde00692dbe$var$getGenerateAuthTokenEndpoint(appConfig, installationEntry);
          headers = $e6cd2a7aef2a824305ae4bde00692dbe$var$getHeadersWithAuth(appConfig, installationEntry);
          body = {
            installation: {
              sdkVersion: $e6cd2a7aef2a824305ae4bde00692dbe$var$PACKAGE_VERSION
            }
          };
          request = {
            method: 'POST',
            headers: headers,
            body: JSON.stringify(body)
          };
          return [4
          /*yield*/
          , fetch(endpoint, request)];

        case 1:
          response = _a.sent();
          if (!response.ok) return [3
          /*break*/
          , 3];
          return [4
          /*yield*/
          , response.json()];

        case 2:
          responseValue = _a.sent();
          completedAuthToken = $e6cd2a7aef2a824305ae4bde00692dbe$var$extractAuthTokenInfoFromResponse(responseValue);
          return [2
          /*return*/
          , completedAuthToken];

        case 3:
          throw $e6cd2a7aef2a824305ae4bde00692dbe$var$getErrorFromResponse('Generate Auth Token', response);
      }
    });
  });
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$getGenerateAuthTokenEndpoint(appConfig, _a) {
  var fid = _a.fid;
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$getInstallationsEndpoint(appConfig) + "/" + fid + "/authTokens:generate";
}
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$getToken(app) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var appConfig;
    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_a) {
      switch (_a.label) {
        case 0:
          appConfig = $e6cd2a7aef2a824305ae4bde00692dbe$var$extractAppConfig(app);
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$completeInstallationRegistration(appConfig)];

        case 1:
          _a.sent(); // At this point we either have a Registered Installation in the DB, or we've
          // already thrown an error.


          return [2
          /*return*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$fetchAuthToken(appConfig)];
      }
    });
  });
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$completeInstallationRegistration(appConfig) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var _a, installationEntry, registrationPromise;

    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_b) {
      switch (_b.label) {
        case 0:
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$getInstallationEntry(appConfig)];

        case 1:
          _a = _b.sent(), installationEntry = _a.installationEntry, registrationPromise = _a.registrationPromise;
          if (!registrationPromise) return [3
          /*break*/
          , 3]; // A createInstallation request is in progress. Wait until it finishes.

          return [4
          /*yield*/
          , registrationPromise];

        case 2:
          // A createInstallation request is in progress. Wait until it finishes.
          _b.sent();

          return [3
          /*break*/
          , 4];

        case 3:
          if (installationEntry.registrationStatus !== 2
          /* COMPLETED */
          ) {
              // Installation ID can't be registered.
              throw $e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_FACTORY.create("create-installation-failed"
              /* CREATE_INSTALLATION_FAILED */
              );
            }

          _b.label = 4;

        case 4:
          return [2
          /*return*/
          ];
      }
    });
  });
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$fetchAuthToken(appConfig) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var tokenPromise, entry, authToken, _a;

    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_b) {
      switch (_b.label) {
        case 0:
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$update(appConfig, function (oldEntry) {
            if (!$e6cd2a7aef2a824305ae4bde00692dbe$var$isEntryRegistered(oldEntry)) {
              throw $e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_FACTORY.create("not-registered"
              /* NOT_REGISTERED */
              );
            }

            var oldAuthToken = oldEntry.authToken;

            if ($e6cd2a7aef2a824305ae4bde00692dbe$var$isAuthTokenValid(oldAuthToken)) {
              // There is a valid token in the DB.
              return oldEntry;
            } else if (oldAuthToken.requestStatus === 1
            /* IN_PROGRESS */
            ) {
                // There already is a token request in progress.
                tokenPromise = $e6cd2a7aef2a824305ae4bde00692dbe$var$waitUntilAuthTokenRequest(appConfig);
                return oldEntry;
              } else {
              // No token or token expired.
              if (!navigator.onLine) {
                throw $e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_FACTORY.create("app-offline"
                /* APP_OFFLINE */
                );
              }

              var inProgressEntry = $e6cd2a7aef2a824305ae4bde00692dbe$var$makeAuthTokenRequestInProgressEntry(oldEntry);
              tokenPromise = $e6cd2a7aef2a824305ae4bde00692dbe$var$fetchAuthTokenFromServer(appConfig, inProgressEntry);
              return inProgressEntry;
            }
          })];

        case 1:
          entry = _b.sent();
          if (!tokenPromise) return [3
          /*break*/
          , 3];
          return [4
          /*yield*/
          , tokenPromise];

        case 2:
          _a = _b.sent();
          return [3
          /*break*/
          , 4];

        case 3:
          _a = entry.authToken;
          _b.label = 4;

        case 4:
          authToken = _a;
          return [2
          /*return*/
          , authToken.token];
      }
    });
  });
}
/**
 * Call only if FID is registered and Auth Token request is in progress.
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$waitUntilAuthTokenRequest(appConfig) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var entry, authToken;
    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_a) {
      switch (_a.label) {
        case 0:
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$updateAuthTokenRequest(appConfig)];

        case 1:
          entry = _a.sent();
          _a.label = 2;

        case 2:
          if (!(entry.authToken.requestStatus === 1
          /* IN_PROGRESS */
          )) return [3
            /*break*/
            , 5]; // generateAuthToken still in progress.

          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$sleep(100)];

        case 3:
          // generateAuthToken still in progress.
          _a.sent();

          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$updateAuthTokenRequest(appConfig)];

        case 4:
          entry = _a.sent();
          return [3
          /*break*/
          , 2];

        case 5:
          authToken = entry.authToken;

          if (authToken.requestStatus === 0
          /* NOT_STARTED */
          ) {
              throw $e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_FACTORY.create("generate-token-failed"
              /* GENERATE_TOKEN_FAILED */
              );
            } else {
            return [2
            /*return*/
            , authToken];
          }

          return [2
          /*return*/
          ];
      }
    });
  });
}
/**
 * Called only if there is a GenerateAuthToken request in progress.
 *
 * Updates the InstallationEntry in the DB based on the status of the
 * GenerateAuthToken request.
 *
 * Returns the updated InstallationEntry.
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$updateAuthTokenRequest(appConfig) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$update(appConfig, function (oldEntry) {
    if (!$e6cd2a7aef2a824305ae4bde00692dbe$var$isEntryRegistered(oldEntry)) {
      throw $e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_FACTORY.create("not-registered"
      /* NOT_REGISTERED */
      );
    }

    var oldAuthToken = oldEntry.authToken;

    if ($e6cd2a7aef2a824305ae4bde00692dbe$var$hasAuthTokenRequestTimedOut(oldAuthToken)) {
      return $e6cd2a7aef2a824305ae4bde00692dbe$var$__assign({}, oldEntry, {
        authToken: {
          requestStatus: 0
          /* NOT_STARTED */

        }
      });
    }

    return oldEntry;
  });
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$fetchAuthTokenFromServer(appConfig, installationEntry) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var authToken, updatedInstallationEntry, e_1, updatedInstallationEntry;
    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_a) {
      switch (_a.label) {
        case 0:
          _a.trys.push([0, 3,, 8]);

          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$generateAuthToken(appConfig, installationEntry)];

        case 1:
          authToken = _a.sent();
          updatedInstallationEntry = $e6cd2a7aef2a824305ae4bde00692dbe$var$__assign({}, installationEntry, {
            authToken: authToken
          });
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$set(appConfig, updatedInstallationEntry)];

        case 2:
          _a.sent();

          return [2
          /*return*/
          , authToken];

        case 3:
          e_1 = _a.sent();
          if (!($e6cd2a7aef2a824305ae4bde00692dbe$var$isServerError(e_1) && (e_1.serverCode === 401 || e_1.serverCode === 404))) return [3
          /*break*/
          , 5]; // Server returned a "FID not found" or a "Invalid authentication" error.
          // Generate a new ID next time.

          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$remove(appConfig)];

        case 4:
          // Server returned a "FID not found" or a "Invalid authentication" error.
          // Generate a new ID next time.
          _a.sent();

          return [3
          /*break*/
          , 7];

        case 5:
          updatedInstallationEntry = $e6cd2a7aef2a824305ae4bde00692dbe$var$__assign({}, installationEntry, {
            authToken: {
              requestStatus: 0
              /* NOT_STARTED */

            }
          });
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$set(appConfig, updatedInstallationEntry)];

        case 6:
          _a.sent();

          _a.label = 7;

        case 7:
          throw e_1;

        case 8:
          return [2
          /*return*/
          ];
      }
    });
  });
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$isEntryRegistered(installationEntry) {
  return installationEntry !== undefined && installationEntry.registrationStatus === 2
  /* COMPLETED */
  ;
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$isAuthTokenValid(authToken) {
  return authToken.requestStatus === 2
  /* COMPLETED */
  && !$e6cd2a7aef2a824305ae4bde00692dbe$var$isAuthTokenExpired(authToken);
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$isAuthTokenExpired(authToken) {
  var now = Date.now();
  return now < authToken.creationTime || authToken.creationTime + authToken.expiresIn < now + $e6cd2a7aef2a824305ae4bde00692dbe$var$TOKEN_EXPIRATION_BUFFER;
}
/** Returns an updated InstallationEntry with an InProgressAuthToken. */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$makeAuthTokenRequestInProgressEntry(oldEntry) {
  var inProgressAuthToken = {
    requestStatus: 1
    /* IN_PROGRESS */
    ,
    requestTime: Date.now()
  };
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__assign({}, oldEntry, {
    authToken: inProgressAuthToken
  });
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$hasAuthTokenRequestTimedOut(authToken) {
  return authToken.requestStatus === 1
  /* IN_PROGRESS */
  && authToken.requestTime + $e6cd2a7aef2a824305ae4bde00692dbe$var$PENDING_TIMEOUT_MS < Date.now();
}
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$deleteInstallation(appConfig, installationEntry) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var endpoint, headers, request, response;
    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_a) {
      switch (_a.label) {
        case 0:
          endpoint = $e6cd2a7aef2a824305ae4bde00692dbe$var$getDeleteEndpoint(appConfig, installationEntry);
          headers = $e6cd2a7aef2a824305ae4bde00692dbe$var$getHeadersWithAuth(appConfig, installationEntry);
          request = {
            method: 'DELETE',
            headers: headers
          };
          return [4
          /*yield*/
          , fetch(endpoint, request)];

        case 1:
          response = _a.sent();

          if (!response.ok) {
            throw $e6cd2a7aef2a824305ae4bde00692dbe$var$getErrorFromResponse('Delete Installation', response);
          }

          return [2
          /*return*/
          ];
      }
    });
  });
}

function $e6cd2a7aef2a824305ae4bde00692dbe$var$getDeleteEndpoint(appConfig, _a) {
  var fid = _a.fid;
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$getInstallationsEndpoint(appConfig) + "/" + fid;
}
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$var$deleteInstallation$1(app) {
  return $e6cd2a7aef2a824305ae4bde00692dbe$var$__awaiter(this, void 0, void 0, function () {
    var appConfig, entry;
    return $e6cd2a7aef2a824305ae4bde00692dbe$var$__generator(this, function (_a) {
      switch (_a.label) {
        case 0:
          appConfig = $e6cd2a7aef2a824305ae4bde00692dbe$var$extractAppConfig(app);
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$update(appConfig, function (oldEntry) {
            if (oldEntry && oldEntry.registrationStatus === 0
            /* NOT_STARTED */
            ) {
                // Delete the unregistered entry without sending a deleteInstallation request.
                return undefined;
              }

            return oldEntry;
          })];

        case 1:
          entry = _a.sent();
          if (!entry) return [3
          /*break*/
          , 6];
          if (!(entry.registrationStatus === 1
          /* IN_PROGRESS */
          )) return [3
            /*break*/
            , 2]; // Can't delete while trying to register.

          throw $e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_FACTORY.create("delete-pending-registration"
          /* DELETE_PENDING_REGISTRATION */
          );

        case 2:
          if (!(entry.registrationStatus === 2
          /* COMPLETED */
          )) return [3
            /*break*/
            , 6];
          if (!!navigator.onLine) return [3
          /*break*/
          , 3];
          throw $e6cd2a7aef2a824305ae4bde00692dbe$var$ERROR_FACTORY.create("app-offline"
          /* APP_OFFLINE */
          );

        case 3:
          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$deleteInstallation(appConfig, entry)];

        case 4:
          _a.sent();

          return [4
          /*yield*/
          , $e6cd2a7aef2a824305ae4bde00692dbe$var$remove(appConfig)];

        case 5:
          _a.sent();

          _a.label = 6;

        case 6:
          return [2
          /*return*/
          ];
      }
    });
  });
}
/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */

/**
 * @license
 * Copyright 2019 Google Inc.
 *
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 *
 *   http://www.apache.org/licenses/LICENSE-2.0
 *
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */


function $e6cd2a7aef2a824305ae4bde00692dbe$export$registerInstallations(instance) {
  var installationsName = 'installations';

  var factoryMethod = function (app) {
    // Throws if app isn't configured properly.
    $e6cd2a7aef2a824305ae4bde00692dbe$var$extractAppConfig(app);
    return {
      app: app,
      getId: function () {
        return $e6cd2a7aef2a824305ae4bde00692dbe$var$getId(app);
      },
      getToken: function () {
        return $e6cd2a7aef2a824305ae4bde00692dbe$var$getToken(app);
      },
      delete: function () {
        return $e6cd2a7aef2a824305ae4bde00692dbe$var$deleteInstallation$1(app);
      }
    };
  };

  instance.INTERNAL.registerService(installationsName, factoryMethod);
}

$e6cd2a7aef2a824305ae4bde00692dbe$export$registerInstallations($e6cd2a7aef2a824305ae4bde00692dbe$import$firebase);
$e6cd2a7aef2a824305ae4bde00692dbe$exports.registerInstallations = $e6cd2a7aef2a824305ae4bde00692dbe$export$registerInstallations;